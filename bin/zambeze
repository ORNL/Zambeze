#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Copyright (c) 2022 Oak Ridge National Laboratory.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the MIT License.

import json
import logging
import typer

from zambeze.orchestration.agent import Agent, ZambezeSettings

logger = logging.getLogger()
app = typer.Typer()


@app.command()
def agent():
    logger.info("Starting Zambeze Agent")
    agent = Agent(logger=logger)
    agent.processor.join()


@app.command()
def config(
    list: bool = typer.Option(
        False, "--list", "-l", help="List configuration options."
    ),
    file: bool = typer.Option(False, "--file", "-f", help="Show config file location."),
):
    settings = ZambezeSettings(logger=logger)
    if file:
        typer.echo(f"Zambeze config file: {settings._conf_file}")
    if list:
        typer.echo(json.dumps(settings.settings, indent=2))


@app.callback()
def main(debug: bool = typer.Option(False, "--debug", help="Enable debug logging.")):
    """
    Manage users in the awesome CLI app.
    """
    logger.setLevel(logging.INFO)
    ch = logging.StreamHandler()
    ch.setLevel(logging.INFO)
    formatter = logging.Formatter(
        "[Zambeze Agent] [%(levelname)s] %(asctime)s - %(message)s"
    )
    if debug:
        logger.setLevel(logging.DEBUG)
        ch.setLevel(logging.DEBUG)

    ch.setFormatter(formatter)
    logger.addHandler(ch)


if __name__ == "__main__":
    app()
